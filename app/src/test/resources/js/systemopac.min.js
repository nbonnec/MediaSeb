var lst_ajax = new Array;
var modal_width = 700;
var modal_height = 500;

function sleep(a) {
    var c = new Date();
    c.setTime(c.getTime() + a);
    var b = c.getTime();
    while (new Date().getTime() < b) {}
}

function loadCouv() {
    var div = $$("div.couverture");
    var length = div.length;
    var f = 0;
    var c = new Array();
    for (i = 0; i < length; i++) {
        if (div[i].id.substr(0, 10) == "couverture") {
            if (div[i].getElement("input[name=ntc_url]") == null) {
                continue
            }
            var b = div[i].getElement("input[name=ntc_url]").value;
            div[i].getElement("input[name=ntc_url]").destroy();
            var e = new Request.HTML({
                url: b,
                method: "get",
                update: div[i]
            });
            lst_ajax[f++] = e;
            e.send();
            sleep(10)
        }
    }
}

function load_notes() {
    var d = new Array();
    var b = $$("span.note_ntc").length;
    for (var e = 0; e < b; e++) {
        var a = $$("span.note_ntc")[e].getProperty("data-ntc");
        d[e] = a
    }
    if (d.length == 0) {
        return
    }
    var c = uri_root + "index.php?option=com_opac&task=get_notes&view=Ajax&format=raw&ntcs=" + d.join();
    var f = new Request.JSON({
        url: c,
        method: "get",
        onComplete: function(g) {
            if (g == undefined) {
                return
            }
            var k = g.length;
            for (var h = 0; h < k; h++) {
                $("note_" + g[h].ntc).set("html", g[h].html)
            }
        }
    });
    f.send()
}

function load_cdcs() {
    var d = new Array();
    var f = $$("span.cdc_ntc");
    var b = f.length;
    for (var e = 0; e < b; e++) {
        var a = f[e].getProperty("data-ntc");
        d[e] = a
    }
    if (d.length == 0) {
        return
    }
    var c = uri_root + "index.php?option=com_opac&task=get_cdcs&view=Ajax&format=raw&ntcs=" + d.join();
    var g = new Request.JSON({
        url: c,
        method: "get",
        onComplete: function(h) {
            if (h == undefined) {
                return
            }
            var l = h.length;
            for (var k = 0; k < l; k++) {
                $("cdc_" + h[k].ntc).getParent().addClass("cdrntc");
                $("cdc_" + h[k].ntc).set("html", h[k].html)
            }
        }
    });
    g.send()
}

function cancelAjax() {
    for (i = 0; i < lst_ajax.length; i++) {
        lst_ajax[i].cancel()
    }
}

function get_modal_width(a) {
    if (a < modal_width) {
        return a
    }
    return modal_width
}

function get_modal_height(a) {
    if (a < modal_height) {
        return a
    }
    return modal_height
}
window.addEvent("domready", function() {
    var e = $("mod-opac-filtres-facettes-droite");
    var c = $("mod-opac-filtres-facettes-gauche");
    var b = [e, c];
    b.each(function(o) {
        if (o != null && o != undefined) {
            var f = o.getElementById("for_task").value;
            var m = o.getElementById("for_view").value;
            var j = o.getElementById("for_layout").value;
            var h = o.getElementById("mod_id").value;
            var k = o.getElementById("itemid").value;
            var l = o.getElementById("pos_fct").value;
            var n = o.getElementById("url_filtre_facette").value;
            var d = n + "index.php?option=com_opac&task=LoadFacettes&format=raw&pos_fct=" + l + "&for_task=" + f + "&for_view=" + m + "&for_layout=" + j + "&Itemid=" + k + "&tmpl=component";
            var g = "layout=" + l;
            var a = new Request.HTML({
                url: d,
                method: "get",
                evalScripts: true,
                update: o,
                data: g
            });
            a.addEvent("onSuccess", function(r, p, s, q) {
                if (s.search("<a href") == -1) {
                    $("Mod" + h).style.display = "none"
                }
            });
            a.send()
        }
    });
    $$("input.button").each(function(a) {
        a.addEvent("click", function() {
            cancelAjax()
        })
    });
    $$("a").each(function(a) {
        if (a.href !== "[object SVGAnimatedString]") {
            if (a.href !== "javascript:void(0)") {
                a.addEvent("click", function() {
                    cancelAjax()
                })
            }
        }
    });
    loadCouv();
    load_notes();
    load_cdcs();
    if (window.getSize().x >= 768) {
        modal_width = 700;
        modal_height = 500
    }
    if (window.getSize().x >= 480 && window.getSize().x < 768) {
        modal_width = window.getSize().x - 80;
        modal_height = window.getSize().y - 80
    }
    if (window.getSize().x >= 0 && window.getSize().x < 480) {
        modal_width = window.getSize().x - 80;
        modal_height = window.getSize().y - 80
    }
});
